local workspaceCharacters = workspace:WaitForChild("Characters")
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local LocalPlayer = Players.LocalPlayer
local CoreGui = game:GetService("CoreGui")

local activeNameTags = {}
local characterConnections = {}
local isCleaning = false

local function cleanAll()
    if isCleaning then return end
    isCleaning = true
    
    for character, bill in pairs(activeNameTags) do
        if bill and bill.Parent then
            bill:Destroy()
        end
        if characterConnections[character] then
            for _, conn in pairs(characterConnections[character]) do
                pcall(function() conn:Disconnect() end)
            end
        end
    end
    
    table.clear(activeNameTags)
    table.clear(characterConnections)
    
    isCleaning = false
end

local function getTeamColor(targetPlayer)
    if not targetPlayer or targetPlayer == LocalPlayer then return nil end
    
    local localTeam = LocalPlayer.Team
    local targetTeam = targetPlayer.Team
    
    if not localTeam or not targetTeam then
        return Color3.fromRGB(255, 255, 0)
    end
    
    if localTeam == targetTeam then
        return Color3.fromRGB(0, 150, 255)
    else
        return Color3.fromRGB(255, 0, 0)
    end
end

local function isValidCharacter(character)
    if not character or not character:IsA("Model") then return false end
    if not character.Parent or character.Parent ~= workspaceCharacters then return false end
    
    local player = Players:GetPlayerFromCharacter(character)
    if not player then return false end
    if player == LocalPlayer then return false end
    
    local humanoid = character:FindFirstChildOfClass("Humanoid")
    if not humanoid or humanoid.Health <= 0 then return false end
    
    return true
end

local function removeNameTag(character)
    if not character then return end
    
    if activeNameTags[character] then
        activeNameTags[character]:Destroy()
        activeNameTags[character] = nil
    end
    
    if characterConnections[character] then
        for _, conn in pairs(characterConnections[character]) do
            pcall(function() conn:Disconnect() end)
        end
        characterConnections[character] = nil
    end
end

local function setupCharacter(character)
    if not isValidCharacter(character) then return end
    
    removeNameTag(character)
    
    local head = character:WaitForChild("Head", 5)
    if not head then return end
    
    local bill = Instance.new("BillboardGui")
    bill.Name = "V3ENO_Name"
    bill.Adornee = head
    bill.Size = UDim2.new(0, 100, 0, 30)
    bill.StudsOffset = Vector3.new(0, 3, 0)
    bill.AlwaysOnTop = true
    bill.MaxDistance = 300
    bill.Enabled = true
    
    local frame = Instance.new("Frame")
    frame.Parent = bill
    frame.BackgroundColor3 = Color3.new(0, 0, 0)
    frame.BackgroundTransparency = 0.5
    frame.Size = UDim2.new(1, 0, 1, 0)
    frame.BorderSizePixel = 0
    
    local label = Instance.new("TextLabel")
    label.Parent = frame
    label.BackgroundTransparency = 1
    label.Size = UDim2.new(1, -4, 1, -4)
    label.Position = UDim2.new(0, 2, 0, 2)
    label.TextSize = 14
    label.Font = Enum.Font.SourceSansBold
    label.TextStrokeTransparency = 0
    label.TextStrokeColor3 = Color3.new(0, 0, 0)
    
    bill.Parent = CoreGui
    activeNameTags[character] = bill
    
    local player = Players:GetPlayerFromCharacter(character)
    local connections = {}
    
    local function update()
        if not bill or bill.Parent ~= CoreGui then return end
        
        local currentPlayer = Players:GetPlayerFromCharacter(character)
        if currentPlayer and character:FindFirstChild("Head") then
            label.Text = player.Name
            local color = getTeamColor(currentPlayer)
            if color then
                label.TextColor3 = color
            else
                removeNameTag(character)
            end
        else
            removeNameTag(character)
        end
    end
    
    if player then
        table.insert(connections, player:GetPropertyChangedSignal("Team"):Connect(update))
        table.insert(connections, LocalPlayer:GetPropertyChangedSignal("Team"):Connect(update))
    end
    
    local humanoid = character:FindFirstChildOfClass("Humanoid")
    if humanoid then
        table.insert(connections, humanoid.Died:Connect(function()
            removeNameTag(character)
        end))
    end
    
    table.insert(connections, character.AncestryChanged:Connect(function()
        if not character or not character.Parent or character.Parent ~= workspaceCharacters then
            removeNameTag(character)
        end
    end))
    
    characterConnections[character] = connections
    update()
end

workspaceCharacters.ChildAdded:Connect(function(child)
    task.wait(0.5)
    setupCharacter(child)
end)

workspaceCharacters.ChildRemoved:Connect(function(child)
    removeNameTag(child)
end)

LocalPlayer.CharacterAdded:Connect(function()
    task.wait(1)
    cleanAll()
    
    for _, player in pairs(Players:GetPlayers()) do
        if player ~= LocalPlayer and player.Character then
            setupCharacter(player.Character)
        end
    end
end)

RunService.Heartbeat:Connect(function()
    for character, bill in pairs(activeNameTags) do
        if not isValidCharacter(character) then
            removeNameTag(character)
        end
    end
end)

task.spawn(function()
    while true do
        task.wait(5)
        cleanAll()
        
        for _, char in pairs(workspaceCharacters:GetChildren()) do
            if isValidCharacter(char) then
                setupCharacter(char)
            end
        end
    end
end)

for _, player in pairs(Players:GetPlayers()) do
    if player ~= LocalPlayer and player.Character then
        task.spawn(setupCharacter, player.Character)
    end
    player.CharacterAdded:Connect(function(character)
        task.wait(1)
        setupCharacter(character)
    end)
end
